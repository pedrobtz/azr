# azr

azr implements a credential chain for seamless OAuth 2.0 authentication
to Azure services. It builds on [httr2](https://httr2.r-lib.org/)’s
OAuth framework to provide cache and automatic credential discovery,
trying different authentication methods in sequence until one succeeds.

## Installation

You can install httr2 from CRAN with:

``` r
install.packages("azr")
```

## Overview

The package supports creating Credential chains for Authentication with:

- **Client Secret Credential**: Service principal authentication with
  client ID and secret
- **Azure CLI Credential**: Leverages existing Azure CLI (`az`) login
- **Authorization Code Flow**: Interactive browser-based authentication
- **Device Code Flow**: Authentication for headless or CLI environments

During interactive development, azr allows browser-based login flows,
while in batch/production mode it seamlessly falls back to
non-interactive methods.

## Usage

The simplest way to authenticate is using
[`get_token()`](https://pedrobtz.github.io/azr/reference/get_token.md),
which automatically tries different authentication methods until one
succeeds:

``` r
library(azr)

# Get a token using the default credential chain
token <- get_token(
  tenant_id = "your-tenant-id",
  scope = "https://management.azure.com/.default"
)

# Use the token with httr2
library(httr2)
req <- request("https://management.azure.com/subscriptions?api-version=2020-01-01") |>
  req_auth_bearer_token(token$access_token)

resp <- req_perform(req)
```

Alternatively, use
[`get_request_authorizer()`](https://pedrobtz.github.io/azr/reference/get_request_authorizer.md)
to get a function that adds authentication to requests:

``` r
library(azr)
library(httr2)

# Get a request authorizer for Microsoft Graph API
azr_req_auth <- get_request_authorizer(
  tenant_id = "your-tenant-id",
  scope = "https://graph.microsoft.com/.default"
)

# Use it to authenticate requests
resp <- request("https://graph.microsoft.com/v1.0/me") |>
  azr_req_auth() |>
  req_perform()
```

You can customize which authentication methods are tried and in what
order:

``` r
# Define a custom credential chain with specific credential instances
custom_chain <- credential_chain(
  ClientSecretCredential$new(
    # e.g. app://mycompany.onmicrosoft.com/MyAppId/DEV/my-api/.default
    scope = Sys.getenv("APP_SCOPE"),
    # the 'Application Id' used in production/batch mode
    client_id = Sys.getenv("APP_CLIENT_ID"),
    client_secret = Sys.getenv("APP_CLIENT_SECRET")
  ),
  # during development the developer authenticates via 'az login --use-device-code'
  AzureCLICredential
)

# Use the custom chain
token <- get_token(
  tenant_id = "mycompany-tenant-id",
  scope = "https://management.azure.com/.default",
  .chain = custom_chain
)
```

### Using with Azure OpenAI and elmer

You can use
[`get_credential_auth()`](https://pedrobtz.github.io/azr/reference/get_credential_auth.md)
to create a chat connection to Azure OpenAI with the
[elmer](https://github.com/hadley/elmer) package:

``` r
library(azr)
library(elmer)

# Create an authentication function for Azure OpenAI
credentials <- get_credential_auth(
  scope = "https://cognitiveservices.azure.com/.default"
)

# Create a chat interface to Azure OpenAI
chat <- chat_azure_openai(
  endpoint = "https://your-resource.openai.azure.com",
  model =  "gpt-4o",
  credentials  = credentials
)

# Use the chat
chat$chat("What is the capital of France?")
```

## Related work

azr is inspired by Python’s
[azure-identity](https://learn.microsoft.com/en-us/python/api/overview/azure/identity-readme)
library, which provides comprehensive coverage of Azure authentication
scenarios and introduced the credential chain pattern for automatic
authentication method discovery.

The R package [AzureAuth](https://github.com/Azure/AzureAuth) (based on
[httr](https://httr.r-lib.org/)) also provides token acquisition for
Azure services, but does not offer an explicit way to define credential
chains. This becomes important in scenarios where different
authentication methods require different configurations. For example:

- **Client Secret Credentials**: Using a service principal `client_id`
  with an application-specific `scope`
- **Interactive Credentials**: Using user authentication with different
  credentials

azr addresses this by allowing you to define custom credential chains
with method-specific configurations, enabling seamless fallback between
authentication approaches.

## Code of Conduct

Please note that the azr project is released with a [Contributor Code of
Conduct](https://contributor-covenant.org/version/2/1/CODE_OF_CONDUCT.html).
By contributing to this project, you agree to abide by its terms.

# Package index

## All functions

- [`AuthCodeCredential`](https://pedrobtz.github.io/azr/reference/AuthCodeCredential.md)
  : Authorization code credential authentication
- [`AzureCLICredential`](https://pedrobtz.github.io/azr/reference/AzureCLICredential.md)
  : Azure CLI credential authentication
- [`ClientSecretCredential`](https://pedrobtz.github.io/azr/reference/ClientSecretCredential.md)
  : Client secret credential authentication
- [`DeviceCodeCredential`](https://pedrobtz.github.io/azr/reference/DeviceCodeCredential.md)
  : Device code credential authentication
- [`api_client`](https://pedrobtz.github.io/azr/reference/api_client.md)
  : Azure API Client
- [`api_resource`](https://pedrobtz.github.io/azr/reference/api_resource.md)
  : Azure API Resource
- [`api_service`](https://pedrobtz.github.io/azr/reference/api_service.md)
  : API Service Base Class
- [`az_cli_account_show()`](https://pedrobtz.github.io/azr/reference/az_cli_account_show.md)
  : Show Azure CLI Account Information
- [`az_cli_get_token()`](https://pedrobtz.github.io/azr/reference/az_cli_get_token.md)
  : Get Access Token from Azure CLI
- [`az_cli_is_login()`](https://pedrobtz.github.io/azr/reference/az_cli_is_login.md)
  : Check if User is Logged in to Azure CLI
- [`az_cli_login()`](https://pedrobtz.github.io/azr/reference/az_cli_login.md)
  : Azure CLI Device Code Login
- [`az_cli_logout()`](https://pedrobtz.github.io/azr/reference/az_cli_logout.md)
  : Azure CLI Logout
- [`azr_graph_client()`](https://pedrobtz.github.io/azr/reference/azr_graph_client.md)
  : Create a Microsoft Graph API Client
- [`credential_chain()`](https://pedrobtz.github.io/azr/reference/credential_chain.md)
  : Create Custom Credential Chain
- [`default_azure_client_id()`](https://pedrobtz.github.io/azr/reference/default_azure_client_id.md)
  : Get default Azure client ID
- [`default_azure_client_secret()`](https://pedrobtz.github.io/azr/reference/default_azure_client_secret.md)
  : Get default Azure client secret
- [`default_azure_config_dir()`](https://pedrobtz.github.io/azr/reference/default_azure_config_dir.md)
  : Get default Azure configuration directory
- [`default_azure_host()`](https://pedrobtz.github.io/azr/reference/default_azure_host.md)
  : Get default Azure authority host
- [`default_azure_oauth_client()`](https://pedrobtz.github.io/azr/reference/default_azure_oauth_client.md)
  : Create default Azure OAuth client
- [`default_azure_scope()`](https://pedrobtz.github.io/azr/reference/default_azure_scope.md)
  : Get default Azure OAuth scope
- [`default_azure_tenant_id()`](https://pedrobtz.github.io/azr/reference/default_azure_tenant_id.md)
  : Get default Azure tenant ID
- [`default_azure_url()`](https://pedrobtz.github.io/azr/reference/default_azure_url.md)
  : Get default Azure OAuth URLs
- [`default_credential_chain()`](https://pedrobtz.github.io/azr/reference/default_credential_chain.md)
  : Create Default Credential Chain
- [`default_non_auth()`](https://pedrobtz.github.io/azr/reference/default_non_auth.md)
  : Default No Authentication
- [`default_redirect_uri()`](https://pedrobtz.github.io/azr/reference/default_redirect_uri.md)
  : Get default OAuth redirect URI
- [`default_response_handler()`](https://pedrobtz.github.io/azr/reference/default_response_handler.md)
  : Default Response Handler
- [`get_credential_auth()`](https://pedrobtz.github.io/azr/reference/get_credential_auth.md)
  : Get Credential Authentication Function
- [`get_credential_provider()`](https://pedrobtz.github.io/azr/reference/get_credential_provider.md)
  : Get Credential Provider
- [`get_request_authorizer()`](https://pedrobtz.github.io/azr/reference/get_request_authorizer.md)
  : Get Default Request Authorizer Function
- [`get_token()`](https://pedrobtz.github.io/azr/reference/get_token.md)
  : Get Authentication Token
- [`get_token_provider()`](https://pedrobtz.github.io/azr/reference/get_token_provider.md)
  : Get Default Token Provider Function
- [`is_hosted_session()`](https://pedrobtz.github.io/azr/reference/is_hosted_session.md)
  : Detect if running in a hosted session

